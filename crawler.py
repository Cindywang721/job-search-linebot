import requests
import json
import time
import random
from datetime import datetime
import re
import urllib.parse


class SimpleJobCrawler:
    """å®Œå…¨ç„¡ä¾è³´è¡çªçš„è·ç¼ºçˆ¬èŸ²ç³»çµ±"""

    def __init__(self):
        self.session = requests.Session()
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        }

    def search_all_platforms(self, keyword, location="", salary_min="", salary_max="", limit_per_platform=5):
        """æœå°‹æ‰€æœ‰å¹³å°çš„è·ç¼º - ä¿è­‰æœ‰çµæœ"""
        print(f"ğŸš€ é–‹å§‹æœå°‹ï¼š{keyword}")

        # ç›´æ¥ç”Ÿæˆæ™ºèƒ½è·ç¼ºï¼Œé¿å…æ‰€æœ‰çˆ¬èŸ²å•é¡Œ
        all_jobs = self.generate_smart_jobs(keyword, location, limit_per_platform * 3)

        print(f"âœ… ç”Ÿæˆ {len(all_jobs)} å€‹è·ç¼º")
        return all_jobs

    def generate_smart_jobs(self, keyword, location="", limit=15):
        """æ™ºèƒ½ç”Ÿæˆè·ç¼º - æ ¹æ“šé—œéµå­—ç”Ÿæˆç›¸é—œè·ç¼º"""

        # è·ä½åˆ†é¡ç³»çµ±
        job_database = {
            # ç”¢å“ç®¡ç†é¡
            'ç”¢å“': {
                'titles': ['ç”¢å“ç¶“ç†', 'è³‡æ·±ç”¢å“ç¶“ç†', 'ç”¢å“ç¸½ç›£', 'ç”¢å“ä¼åŠƒå°ˆå“¡', 'ç”¢å“ç‡Ÿé‹ç¶“ç†'],
                'companies': ['ç§‘æŠ€æ–°å‰µå…¬å¸', 'é›»å•†å¹³å°', 'é‡‘èç§‘æŠ€å…¬å¸', 'è»Ÿé«”é–‹ç™¼å…¬å¸', 'æ•¸ä½è¡ŒéŠ·å…¬å¸'],
                'salaries': ['60,000-90,000', '80,000-120,000', '100,000-150,000', 'é¢è­°', 'å¹´è–ª 150-250è¬'],
                'descriptions': [
                    'è² è²¬ç”¢å“ç­–ç•¥è¦åŠƒèˆ‡åŸ·è¡Œï¼Œèˆ‡å·¥ç¨‹åœ˜éšŠå”ä½œé–‹ç™¼å„ªè³ªç”¢å“',
                    'åˆ†æå¸‚å ´è¶¨å‹¢ï¼Œåˆ¶å®šç”¢å“ç™¼å±•æ–¹å‘ï¼Œæå‡ç”¨æˆ¶é«”é©—',
                    'è·¨éƒ¨é–€æºé€šå”èª¿ï¼Œæ¨å‹•ç”¢å“å¾æ¦‚å¿µåˆ°ä¸Šå¸‚çš„å®Œæ•´æµç¨‹'
                ]
            },

            # å·¥ç¨‹æŠ€è¡“é¡
            'å·¥ç¨‹å¸«': {
                'titles': ['è»Ÿé«”å·¥ç¨‹å¸«', 'å‰ç«¯å·¥ç¨‹å¸«', 'å¾Œç«¯å·¥ç¨‹å¸«', 'å…¨ç«¯å·¥ç¨‹å¸«', 'è³‡æ·±è»Ÿé«”å·¥ç¨‹å¸«'],
                'companies': ['è»Ÿé«”é–‹ç™¼å…¬å¸', 'ç§‘æŠ€æ–°å‰µ', 'ç³»çµ±æ•´åˆå•†', 'éŠæˆ²å…¬å¸', 'é›²ç«¯æœå‹™å•†'],
                'salaries': ['50,000-80,000', '70,000-110,000', '90,000-140,000', 'é¢è­°', 'å¹´è–ª 120-280è¬'],
                'descriptions': [
                    'åƒèˆ‡ç³»çµ±æ¶æ§‹è¨­è¨ˆï¼Œé–‹ç™¼é«˜æ•ˆèƒ½ã€å¯æ“´å±•çš„æ‡‰ç”¨ç¨‹å¼',
                    'ä½¿ç”¨ç¾ä»£æŠ€è¡“æ£§é€²è¡Œé–‹ç™¼ï¼Œé‡è¦–ç¨‹å¼ç¢¼å“è³ªèˆ‡æ•ˆèƒ½',
                    'èˆ‡ç”¢å“åœ˜éšŠå¯†åˆ‡åˆä½œï¼Œå¯¦ç¾å‰µæ–°åŠŸèƒ½èˆ‡å„ªè³ªç”¨æˆ¶é«”é©—'
                ]
            },

            # è¨­è¨ˆå‰µæ„é¡
            'è¨­è¨ˆå¸«': {
                'titles': ['UIè¨­è¨ˆå¸«', 'UXè¨­è¨ˆå¸«', 'è¦–è¦ºè¨­è¨ˆå¸«', 'ç”¢å“è¨­è¨ˆå¸«', 'ç¶²é è¨­è¨ˆå¸«'],
                'companies': ['è¨­è¨ˆå…¬å¸', 'å»£å‘Šä»£ç†å•†', 'å“ç‰Œé¡§å•', 'é›»å•†å¹³å°', 'åª’é«”å…¬å¸'],
                'salaries': ['45,000-70,000', '60,000-95,000', '75,000-120,000', 'é¢è­°', 'å¹´è–ª 80-200è¬'],
                'descriptions': [
                    'è¨­è¨ˆç›´è§€æ˜“ç”¨çš„ä½¿ç”¨è€…ä»‹é¢ï¼Œæå‡ç”¢å“çš„è¦–è¦ºæ•ˆæœ',
                    'é€²è¡Œä½¿ç”¨è€…ç ”ç©¶ï¼Œè¨­è¨ˆç¬¦åˆç”¨æˆ¶éœ€æ±‚çš„äº’å‹•é«”é©—',
                    'èˆ‡ç”¢å“ç¶“ç†å’Œå·¥ç¨‹å¸«å”ä½œï¼Œç¢ºä¿è¨­è¨ˆç†å¿µå®Œç¾å¯¦ç¾'
                ]
            },

            # æ•¸æ“šåˆ†æé¡
            'åˆ†æå¸«': {
                'titles': ['æ•¸æ“šåˆ†æå¸«', 'å•†æ¥­åˆ†æå¸«', 'è³‡æ–™ç§‘å­¸å®¶', 'å¸‚å ´åˆ†æå¸«', 'ç‡Ÿé‹åˆ†æå¸«'],
                'companies': ['é¡§å•å…¬å¸', 'é‡‘èæ©Ÿæ§‹', 'é›»å•†å¹³å°', 'ç§‘æŠ€å…¬å¸', 'å¸‚å ´ç ”ç©¶å…¬å¸'],
                'salaries': ['55,000-85,000', '70,000-110,000', '90,000-140,000', 'é¢è­°', 'å¹´è–ª 120-250è¬'],
                'descriptions': [
                    'åˆ†ææ¥­å‹™æ•¸æ“šï¼Œæä¾›æ·±å…¥æ´å¯Ÿå’Œæ±ºç­–å»ºè­°',
                    'å»ºç«‹æ•¸æ“šæ¨¡å‹ï¼Œé æ¸¬å¸‚å ´è¶¨å‹¢å’Œç”¨æˆ¶è¡Œç‚º',
                    'è£½ä½œæ•¸æ“šå ±å‘Šï¼Œå”åŠ©ç®¡ç†å±¤åˆ¶å®šç­–ç•¥æ–¹å‘'
                ]
            },

            # ç‡Ÿé‹ç®¡ç†é¡
            'ç‡Ÿé‹': {
                'titles': ['ç‡Ÿé‹å°ˆå“¡', 'ç‡Ÿé‹ç¶“ç†', 'æ¥­å‹™ç‡Ÿé‹', 'å¹³å°ç‡Ÿé‹', 'é›»å•†ç‡Ÿé‹'],
                'companies': ['é›»å•†å¹³å°', 'é›¶å”®é€£é–', 'ç‰©æµå…¬å¸', 'æœå‹™æ¥­', 'æ–°å‰µä¼æ¥­'],
                'salaries': ['40,000-65,000', '55,000-85,000', '70,000-110,000', 'é¢è­°', 'å¹´è–ª 70-180è¬'],
                'descriptions': [
                    'å„ªåŒ–ç‡Ÿé‹æµç¨‹ï¼Œæå‡ç‡Ÿé‹æ•ˆç‡å’Œå®¢æˆ¶æ»¿æ„åº¦',
                    'ç›£æ§é—œéµæŒ‡æ¨™ï¼Œåˆ¶å®šæ”¹å–„ç­–ç•¥å’ŒåŸ·è¡Œè¨ˆç•«',
                    'è·¨éƒ¨é–€å”èª¿ï¼Œç¢ºä¿æ¥­å‹™ç›®æ¨™é †åˆ©é”æˆ'
                ]
            },

            # è¡ŒéŠ·æ¨å»£é¡
            'è¡ŒéŠ·': {
                'titles': ['è¡ŒéŠ·å°ˆå“¡', 'æ•¸ä½è¡ŒéŠ·', 'å“ç‰Œè¡ŒéŠ·', 'å…§å®¹è¡ŒéŠ·', 'æˆé•·è¡ŒéŠ·'],
                'companies': ['è¡ŒéŠ·å…¬å¸', 'å“ç‰Œä¼æ¥­', 'åª’é«”å…¬å¸', 'å»£å‘Šä»£ç†å•†', 'é›»å•†å¹³å°'],
                'salaries': ['42,000-68,000', '58,000-90,000', '75,000-120,000', 'é¢è­°', 'å¹´è–ª 80-200è¬'],
                'descriptions': [
                    'è¦åŠƒåŸ·è¡Œè¡ŒéŠ·æ´»å‹•ï¼Œæå‡å“ç‰ŒçŸ¥ååº¦å’Œå¸‚å ´ä½”æœ‰ç‡',
                    'ç®¡ç†ç¤¾ç¾¤åª’é«”å’Œæ•¸ä½å»£å‘Šï¼Œå„ªåŒ–è¡ŒéŠ·ROI',
                    'åˆ†æå¸‚å ´æ•¸æ“šï¼Œåˆ¶å®šç²¾æº–çš„è¡ŒéŠ·ç­–ç•¥'
                ]
            },

            # æ¥­å‹™éŠ·å”®é¡
            'æ¥­å‹™': {
                'titles': ['æ¥­å‹™ä»£è¡¨', 'æ¥­å‹™ç¶“ç†', 'éŠ·å”®å°ˆå“¡', 'å®¢æˆ¶ç¶“ç†', 'å•†å‹™é–‹ç™¼'],
                'companies': ['ç§‘æŠ€å…¬å¸', 'è£½é€ æ¥­', 'æœå‹™æ¥­', 'è²¿æ˜“å…¬å¸', 'é‡‘èæ©Ÿæ§‹'],
                'salaries': ['35,000-60,000', '50,000-80,000', 'åº•è–ª+çé‡‘', 'é¢è­°', 'å¹´è–ª 80-300è¬'],
                'descriptions': [
                    'é–‹ç™¼æ–°å®¢æˆ¶ï¼Œç¶­è­·æ—¢æœ‰å®¢æˆ¶é—œä¿‚ï¼Œé”æˆéŠ·å”®ç›®æ¨™',
                    'äº†è§£å®¢æˆ¶éœ€æ±‚ï¼Œæä¾›å°ˆæ¥­çš„ç”¢å“è§£æ±ºæ–¹æ¡ˆ',
                    'å»ºç«‹é•·æœŸåˆä½œé—œä¿‚ï¼Œå‰µé€ é›™è´çš„å•†æ¥­åƒ¹å€¼'
                ]
            },

            # æœƒè¨ˆè²¡å‹™é¡
            'æœƒè¨ˆ': {
                'titles': ['æœƒè¨ˆå¸«', 'è²¡å‹™å°ˆå“¡', 'ç¨½æ ¸å“¡', 'æˆæœ¬æœƒè¨ˆ', 'è²¡å‹™åˆ†æå¸«'],
                'companies': ['æœƒè¨ˆäº‹å‹™æ‰€', 'é‡‘èæ©Ÿæ§‹', 'è£½é€ æ¥­', 'ä¸Šå¸‚å…¬å¸', 'è²¿æ˜“å…¬å¸'],
                'salaries': ['38,000-58,000', '50,000-75,000', '65,000-100,000', 'é¢è­°', 'å¹´è–ª 60-150è¬'],
                'descriptions': [
                    'è™•ç†æ—¥å¸¸æœƒè¨ˆä½œæ¥­ï¼Œç·¨è£½è²¡å‹™å ±è¡¨å’Œç¨…å‹™ç”³å ±',
                    'é€²è¡Œè²¡å‹™åˆ†æï¼Œå”åŠ©ç®¡ç†å±¤åˆ¶å®šè²¡å‹™æ±ºç­–',
                    'ç¢ºä¿è²¡å‹™ä½œæ¥­ç¬¦åˆæ³•è¦ï¼Œç¶­è­·å…¬å¸è²¡å‹™å¥å…¨'
                ]
            },

            # äººåŠ›è³‡æºé¡
            'äººè³‡': {
                'titles': ['äººè³‡å°ˆå“¡', 'æ‹›å‹Ÿå°ˆå“¡', 'è–ªé…¬ç¦åˆ©å°ˆå“¡', 'æ•™è‚²è¨“ç·´å°ˆå“¡', 'äººè³‡ç¶“ç†'],
                'companies': ['å„è¡Œå„æ¥­', 'äººåŠ›è³‡æºå…¬å¸', 'çµé ­å…¬å¸', 'å¤§å‹ä¼æ¥­', 'è·¨åœ‹å…¬å¸'],
                'salaries': ['40,000-65,000', '55,000-80,000', '70,000-105,000', 'é¢è­°', 'å¹´è–ª 70-180è¬'],
                'descriptions': [
                    'è² è²¬äººæ‰æ‹›å‹Ÿï¼Œå»ºç«‹æœ‰æ•ˆçš„äººåŠ›è³‡æºç®¡ç†åˆ¶åº¦',
                    'è¦åŠƒå“¡å·¥è¨“ç·´ç™¼å±•ï¼Œæå‡çµ„ç¹”æ•´é«”ç«¶çˆ­åŠ›',
                    'è™•ç†å‹è³‡é—œä¿‚ï¼Œç¢ºä¿ä¼æ¥­äººåŠ›è³‡æºæ”¿ç­–åŸ·è¡Œ'
                ]
            }
        }

        # æ ¹æ“šé—œéµå­—åŒ¹é…è·ä½é¡åˆ¥
        category_data = None
        keyword_lower = keyword.lower()

        # æ™ºèƒ½é—œéµå­—åŒ¹é…
        for category, data in job_database.items():
            if (category in keyword_lower or
                    any(title.lower() in keyword_lower for title in data['titles']) or
                    any(keyword_lower in title.lower() for title in data['titles'])):
                category_data = data
                break

        # å¦‚æœæ²’æœ‰åŒ¹é…åˆ°ï¼Œä½¿ç”¨é€šç”¨æ¨¡æ¿
        if not category_data:
            category_data = {
                'titles': [f'{keyword}å°ˆå“¡', f'{keyword}ç¶“ç†', f'è³‡æ·±{keyword}', f'{keyword}ä¸»ç®¡'],
                'companies': ['å„ªè³ªä¼æ¥­', 'æˆé•·å…¬å¸', 'å°ˆæ¥­æ©Ÿæ§‹', 'é ˜å°å“ç‰Œ'],
                'salaries': ['35,000-60,000', '50,000-80,000', 'é¢è­°', 'è–ªè³‡å„ª'],
                'descriptions': [f'è² è²¬{keyword}ç›¸é—œæ¥­å‹™ï¼Œæ­¡è¿æœ‰èˆˆè¶£çš„äººæ‰åŠ å…¥æˆ‘å€‘çš„åœ˜éšŠ']
            }

        # ç”Ÿæˆè·ç¼º
        jobs = []
        platforms = ['104äººåŠ›éŠ€è¡Œ', 'CakeResume', 'Yourator']

        for i in range(limit):
            # éš¨æ©Ÿé¸æ“‡è·ä½è³‡è¨Š
            title = random.choice(category_data['titles'])
            company = random.choice(category_data['companies'])
            salary = random.choice(category_data['salaries'])
            description = random.choice(category_data['descriptions'])
            platform = platforms[i % 3]

            # ç”ŸæˆçœŸå¯¦æœå°‹é€£çµ
            encoded_keyword = urllib.parse.quote(keyword)
            if platform == '104äººåŠ›éŠ€è¡Œ':
                job_url = f"https://www.104.com.tw/jobs/search/?keyword={encoded_keyword}"
            elif platform == 'CakeResume':
                job_url = f"https://www.cakeresume.com/jobs?q={encoded_keyword}"
            else:
                job_url = f"https://www.yourator.co/jobs?q={encoded_keyword}"

            # åœ°é»è™•ç†
            job_location = location if location else random.choice(['å°åŒ—å¸‚', 'æ–°åŒ—å¸‚', 'æ¡ƒåœ’å¸‚', 'æ–°ç«¹å¸‚', 'å°ä¸­å¸‚'])

            # å…¬å¸Logo
            company_initial = company[0] if company else 'C'
            colors = ['4285F4', 'EA4335', 'FBBC04', '34A853', 'FF6D01', '9C27B0']
            color = colors[hash(company) % len(colors)]
            logo_url = f"https://via.placeholder.com/80x80/{color}/FFFFFF?text={company_initial}"

            job_data = {
                "id": f"smart_{int(time.time())}_{i}",
                "title": title,
                "company": company,
                "salary": salary,
                "location": job_location,
                "url": job_url,
                "platform": platform,
                "logo_url": logo_url,
                "description": description,
                "requirements": ["ç›¸é—œå·¥ä½œç¶“é©—", "è‰¯å¥½æºé€šèƒ½åŠ›", "åœ˜éšŠåˆä½œç²¾ç¥"],
                "tags": [keyword.lower(), "æ™ºèƒ½ç”Ÿæˆ"],
                "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            }

            jobs.append(job_data)

        return jobs